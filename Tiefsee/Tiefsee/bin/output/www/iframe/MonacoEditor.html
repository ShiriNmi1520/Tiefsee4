<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>MonacoEditor</title>

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        #viewer {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>

    <div id="viewer"></div>

    <script>

        var editor;
        var pathLib;
        var pathJs;

        document.addEventListener("DOMContentLoaded", async () => {
            await initJs();
            initPDFTronWebviewer();
        });

        window.addEventListener("message", (e) => {

            //只開放特定網域呼叫
            /*if (e.origin !== "null") {
                console.error("錯誤的請求來源：" + e.origin)
                return;
            }*/

            //接收到的資料
            let type = e.data.type;
            let data = e.data.data;

            if (type === "load") {
                loadFile(data.path, data.txt);
            }
            if (type === "closeDocument") {
                closeDocument()
            }
        });


        /**
         * 初始化載入js
         */
        async function initJs() {
            var getUrlString = location.href;
            var url = new URL(getUrlString);
            var appInfo = url.searchParams.get("appInfo");
            appInfo = JSON.parse(appInfo);
            let appDataPath = appInfo.appDataPath.replace(/\\/g, "/");

            pathLib = "file:///" + appDataPath + "/Plugin/monaco-editor/min/vs";
            pathJs = pathLib + "/loader.js";

            var script = document.createElement("script");
            script.src = pathJs;
            document.head.appendChild(script);

            await new Promise((resolve, reject) => {
                script.onload = function () {
                    resolve(1);
                };
            })
        }


        /**
         *   初始化套件
         */
        async function initPDFTronWebviewer() {

            require.config({ paths: { "vs": pathLib } });
            require(["vs/editor/editor.main"], () => {

                // 初始化變量
                var fileCounter = 0;
                var editorArray = [];
                var defaultCode = `
                    function helloWorld() {
                       console.log('Hello world!');
                    }
                `;

                // 定義編輯器主題
                /*monaco.editor.defineTheme("myTheme", {
                    base: "vs",
                    inherit: true,
                    rules: [{ background: "EDF9FA" }],
                });
                monaco.editor.setTheme("myTheme");*/

                monaco.editor.setTheme("vs-dark");

                editor = monaco.editor.create(document.getElementById("viewer"), {
                    //model: model,
                });

                //告知父物件 已經初始化完成
                let json = {
                    type: "initFinishMonacoEditor",
                    data: "",
                };
                postMsg(json);

            });

        }


        /**
         * 清空文件
         */
        function closeDocument() {
            instance.UI.closeDocument();
        }


        /**
         * 載入檔案
         */
        async function loadFile(path, txt) {
            monaco.editor.getModels().forEach(model => model.dispose());//清除所有已存在的 Model
            var model = monaco.editor.createModel(txt, undefined, monaco.Uri.file(path));
            editor.setModel(model);
        }


        /**
         * 傳送資料給父物件
         */
        function postMsg(json) {
            parent.postMessage(json, "*");
        }

    </script>
</body>

</html>